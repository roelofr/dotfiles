#!/usr/bin/env php
<?php

// Trusted network list
const TRUSTED_NETWORKS = [
    "BING BONG, CHINA",
    "CHINA",
    "ChooChoo",
    "ChooChooChoo",
    "eduroam",
    "Ethernet",
    "VacatureProfs 5G",
    "VacatureProfs",
];

$networks = [];
$exitCode = null;
exec('nmcli --terse --fields type,name connection show --active', $networks, $exitCode);

$networks = array_filter($networks, function ($value) {
    return !empty(trim($value));
});

// If non-zero exit, exit with that code
if ($exitCode !== 0) {
    exit($exitCode);
}

// Keep track of usable networks
$usableNetworks = [];

foreach ($networks as $network) {
    // Format is "type:name".
    list($networkType, $networkName) = explode(':', $network, 2);

    // Skip bridges and bluetooth connetions
    if (in_array($networkType, ['bridge', 'bluetooth'])) {
        continue;
    }

    if ($networkType === 'ethernet') {
        printf("Network [%s] is ethernet. Using wildcard.\n", $networkName);
        exit(0);
    }

    $usableNetworks[] = $networkName;

    if (in_array($networkName, TRUSTED_NETWORKS)) {
        printf("I can trust [%s], so it's ok!\n", $networkName);
        exit(0);
    }
}

// Report failure
printf(
    "Could not find network I could trust. Checked [%s] against %d networks.\n",
    implode(', ', $usableNetworks),
    count(TRUSTED_NETWORKS)
);

// Throw error
exit(1);
