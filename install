#!/usr/bin/env bash
# vim: set ts=4 sw=4 sts=0 sta et :

###
#
# Installs all dotfiles by symlinking them to this directory.
#
# Author: Roelof Roos
# License: GPL-3
#
###

dot_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

C_ERR="$( tput setaf 1 )"
C_INFO="$( tput setaf 2 )"
C_COMMENT="$( tput setaf 3 )"
C_NOTE="$( tput setaf 7 )"
C_CMD="$( tput setaf 6 )"
C_RES="$( tput sgr0 )"

echo -e "${C_NOTE}Using \"${C_COMMENT}${dot_dir}${C_NOTE}\" as base directory${C_RES}"

polybar_files=(config launch.sh)
i3_files=(bootclean.sh config screenshot dmenu)
sway_files=(config fuzzy-finder screenshot config.d)
fontconfig_files=(50-no-batang.conf)
font_files=(\
    fontawesome-pro-brands-400.otf \
    fontawesome-pro-solid-900.otf \
    fontawesome-pro-regular-400.otf \
    fontawesome-pro-light-300.otf \
)
zsh_files=(.zshrc .bash_aliases .bash_functions)
bin_files=$(find "${dot_dir}/bin/" -type f -executable -printf '%f ')

function map_files() {
    source_dir="$( realpath "$dot_dir/$1" )"
    target_dir="${HOME}/$2"
    shift 2

    echo -e "\n${C_COMMENT}Installing ${C_INFO}$( basename "${source_dir}" )${C_COMMENT}...${C_RES}"

    if [ ! -d "$target_dir" ]; then
        echo "  ${C_NOTE}Creating directory ${C_INFO}${target_dir}${C_RES}"
        echo "+ ${C_CMD}mkdir \"$target_dir\"${C_RES}"
        mkdir "$target_dir"
    fi

    target_dir="$( realpath "${target_dir}" )"

    for file in $*
    do
        echo -e "  ${C_NOTE}Evaluating ${C_INFO}${file}${C_NOTE}...${C_RES}"
        target="${target_dir}/$(basename "$file" )"

        # Check if file is broken symlink
        if [ -h "$target" -a ! -e "$target" ]
        then
            echo "  ${C_NOTE}File ${C_INFO}$(basename "$file")${C_NOTE} is broken symlink.${C_RES}"
            echo "    ${C_INFO}deleting...${C_RES}"
            rm "$target"
        fi

        # Check if file exists
        if [ -e "$target" ]
        then
            echo "  ${C_NOTE}File ${C_INFO}$(basename "$file")${C_NOTE} already exists, skipping.${C_RES}"
            continue
        fi

        if [ -N "$target" ]
        then
            echo "  ${C_NOTE}File ${C_INFO}$(basename "$file")${C_NOTE} already linked!${C_RES}"
            continue
        fi

        if [ ! -f "${source_dir}/${file}" -a ! -d "$source_dir/$file" ]
        then
            echo "  ${C_ERR}Source file or directory ${C_COMMENT}$( basename "$file" )${C_ERR} not found.${C_RES}"
            exit 255
        fi

        echo "  ${C_NOTE}Linking ${C_COMMENT}${target}${C_NOTE} to ${C_INFO}${source_dir}/${file}${C_NOTE}...${C_RES}"
        echo "  + ${C_CMD}ln -s \"${source_dir}/${file}\" \"${target}\"${C_RES}"
        ln -s "${source_dir}/${file}" "${target}"
    done
}

# Create links, and optionally directories
# Polybar
map_files polybar ".config/polybar" ${polybar_files[@]}

# i3
map_files i3 ".config/i3" ${i3_files[@]}

# sway
map_files sway ".config/sway" ${sway_files[@]}

# Redshift
map_files redshift ".config" redshift.conf

# Waybar
map_files waybar ".config/waybar" config scripts

# Mako
map_files mako ".config/mako" config

# Fontconfig and fonts
map_files fontconfig ".config/fontconfig/conf.d" ${fontconfig_files[@]}
map_files fonts ".local/share/fonts/" ${font_files[@]}

# Binary files
map_files "bin" "bin" ${bin_files[@]}

# Zsh
map_files "zsh" "." ${zsh_files[@]}

# Create some mandatory files
echo -e "${C_NOTE}Creating GitHub token storage for Polybar${C_RES}"
echo -e "+ ${C_CMD}touch \"~/.config/polybar/github.token\"${C_RES}"
touch "${HOME}/.config/polybar/github.token"

echo -e "${C_NOTE}Creating User-wide git config dir${C_RES}"

echo -e "+ ${C_CMD}mkdir "~/.config/git"${C_RES}"
mkdir -p "${HOME}/.config/git/"

echo -e "${C_NOTE}Creating user-customizable ignore file${C_RES}"
echo -e "+ ${C_CMD}touch "~/.config/git/ignore-user"${C_RES}"
touch "${HOME}/.config/git/ignore-user"

echo -e "${C_NOTE}Downloading and building ignore file${C_RES}"
echo -e "+ ${C_CMD}curl${C_RES} (x2) and ${C_CMD}tee${C_RES}..."
tee "${HOME}/.config/git/ignore" > /dev/null <<IGNORE
# vim: set ft=conf :
# Start of System-wide GIT ignore file
#
# Author: Roelof Roos
# Last update: $( date )

#############################################################
#                                                           #
#    DO NOT EDIT THIS FILE, CHANGES WILL BE OVERWRITTEN.    #
#  EDIT ~/.config/git/ignore-user INSTEAD AND RUN install   #
#                                                           #
#############################################################

### Start of Octocat gist ###
### See https://gist.github.com/octocat/9257657 ###

$( curl -L -o- https://gist.githubusercontent.com/octocat/9257657/raw/.gitignore )

### End of Octocat gist ###

### Start of gitignore.io ###
### See https://gitignore.io/api/linux,sublimetext,phpstorm ###

$( curl -L -o- https://gitignore.io/api/linux,sublimetext,phpstorm )

### End of gitignore.io ###

### Start of user ignore file ###
### See ${HOME}/.config/git/ignore-user ###

$( cat "${HOME}/.config/git/ignore-user" )

### End of user ignore file ###

IGNORE

echo -e "${C_NOTE}Informing git of the new file${C_RES}"
echo -e "+ ${C_CMD}git config --global core.excludesfile "~/.config/git/ignore"${C_RES}"
git config --global core.excludesfile "${HOME}/.config/git/ignore"


# Install SSH ident
echo -e "${C_COMMENT}Installing ssh-ident${C_RES}"
echo -e "  ${C_NOTE}Installing ssh-ident binary${C_RES}"
if [ ! -f /usr/src/ssh-ident/ssh-ident ]; then
    echo -e "  + ${C_CMD}sudo git clone https://github.com/ccontavalli/ssh-ident.git /usr/src/ssh-ident/${C_RES}"
    sudo --prompt="Enter password for %u to install ssh-ident: " \
            git clone https://github.com/ccontavalli/ssh-ident.git /usr/src/ssh-ident/ \
            | true
else
    echo "  ${C_RES}Already installed${C_RES}"
fi

echo -e "  ${C_NOTE}Installing blank configuration${C_RES}"
if [ ! -f "${HOME}/.ssh-ident" ]; then
    echo -e "  + ${C_CMD}tee "~/.ssh-ident"${C_RES}"
	tee "$HOME/.ssh-ident" > /dev/null <<CONFIG
# Specifies which identity to use depending on the path I'm running ssh
# from.
# For example: ("mod-xslt", "personal") means that for any path that
# contains the word "mod-xslt", the "personal" identity should be used.
# This is optional - don't include any MATCH_PATH if you don't need it.
MATCH_PATH = [
    # (directory pattern, identity)
    (r"mod-xslt", "personal"),
    (r"ssh-ident", "personal"),
    (r"opt/work", "work"),
    (r"opt/private", "secret"),
]

# If any of the ssh arguments have 'cweb' in it, the 'personal' identity
# has to be used. For example: "ssh myhost.cweb.com" will have cweb in
# argv, and the "personal" identity will be used.
# This is optional - don't include any MATCH_ARGV if you don't
# need it.
MATCH_ARGV = [
    (r"cweb", "personal"),
    (r"corp", "work"),
]

# Note that if no match is found, the DEFAULT_IDENTITY is used. This is
# generally your loginname, no need to change it.
# This is optional - don't include any DEFAULT_IDENTITY if you don't
# need it.
# DEFAULT_IDENTITY = "foo"

# This is optional - don't include any SSH_ADD_OPTIONS if you don't
# need it.
SSH_ADD_OPTIONS = {
    # Regardless, ask for confirmation before using any of the
    # work keys.
    "work": "-c",
    # Forget about secret keys after ten minutes. ssh-ident will
    # automatically ask you your passphrase again if they are needed.
    "secret": "-t 600",
}

# This is optional - dont' include any SSH_OPTIONS if you don't
# need it.
# Otherwise, provides options to be passed to 'ssh' for specific
# identities.
SSH_OPTIONS = {
    # Disable forwarding of the agent, but enable X forwarding,
    # when using the work profile.
    "work": "-Xa",

    # Always forward the agent when using the secret identity.
    "secret": "-A",
}

# Options to pass to ssh by default.
# If you don't specify anything, UserRoaming=no is passed, due
# to CVE-2016-0777. Leave it empty to disable this.
SSH_DEFAULT_OPTIONS = "-oUseRoaming=no"

# Which options to use by default if no match with SSH_ADD_OPTIONS
# was found. Note that ssh-ident hard codes -t 7200 to prevent your
# keys from remaining in memory for too long.
SSH_ADD_DEFAULT_OPTIONS = "-t 7200"

# Output verbosity
# valid values are: LOG_ERROR, LOG_WARN, LOG_INFO, LOG_DEBUG
VERBOSITY = LOG_INFO
CONFIG
else
    echo -e "  ${C_RES}Already exists${C_RES}"
fi
echo -e "  ${C_COMMENT}done${C_RES}\n"

# Add zsh user-level autocomplete
echo -e "${C_COMMENT}Installing user-level zsh autocomplete${C_RES}"
if [ ! -d "$HOME/.config/zsh-complete" ]; then
    echo -e "  + ${C_CMD}mkdir ~/.config/zsh-complete${C_RES}"
    mkdir "$HOME/.config/zsh-complete"
    chmod go-rwx "$HOME/.config/zsh-complete"

    echo -e "${C_NOTE}Adding Unix Pass support"
    echo -e "  + ${C_CMD}curl https://git.zx2c4.com/…/pass.zsh-completion${C_RES}"
    curl -o \
        "$HOME/.config/zsh-complete/pass.zsh-completion" \
        https://git.zx2c4.com/password-store/plain/src/completion/pass.zsh-completion
else
    echo "  ${C_RES}Already installed${C_RES}"
fi

echo -e "${C_COMMENT}Installing PlantUML${C_RES}"
if [ ! -f "$HOME/Apps/plantuml.jar" ]; then
    test -d "$HOME/Apps" || mkdir -p "$HOME/Apps"

    echo -e "${C_NOTE}Downloading JAR file"
    echo -e "  + ${C_CMD}curl https://git.zx2c4.com/…/pass.zsh-completion${C_RES}"
    curl -Lo "$HOME/Apps/plantuml.jar" \
        http://sourceforge.net/projects/plantuml/files/plantuml.jar/download
else
    echo "  ${C_RES}Already installed${C_RES}"
fi

# Add Plug for Vim
echo -e "${C_COMMENT}Installing Plug for vim${C_RES}"
if [ -f "$HOME/.vim/autoload/plug.vim" ]; then
    echo "  ${C_RES}Already installed${C_RES}"
else
    echo -e "${C_NOTE}Installing Plug for Vim"
    echo -e "  + ${C_CMD}curl https://raw.githubusercontent.com/…/plug.vim${C_RES}"

    curl -fLo "$HOME/.vim/autoload/plug.vim" --create-dirs \
        https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
fi
echo -e "\n${C_INFO}All done!${C_RES}"
